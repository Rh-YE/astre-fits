<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FITS 文件查看器</title>
    <link rel="stylesheet" href="theme.css">
    <script type="module">
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { vscode, log } = await import('./common.js');
                const { default: ImageViewer } = await import('./image-viewer.js');
                const { default: SpectrumViewer } = await import('./spectrum-viewer.js');
                
                // 初始化图像查看器和光谱查看器
                const imageViewer = new ImageViewer();
                const spectrumViewer = new SpectrumViewer();
                
                // 添加容器大小变化监听
                const container = document.querySelector('.image-container');
                const resizeObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        // 重新渲染图像
                        if (imageViewer.currentImageData) {
                            imageViewer.renderWithTransform();
                        }
                        
                        // 重新渲染光谱
                        const spectrumData = document.getElementById('spectrum-canvas').dataset.spectrumData;
                        if (spectrumData) {
                            spectrumViewer.renderSpectrum(JSON.parse(spectrumData), true);
                        }
                    }
                });
                
                // 开始监听容器大小变化
                resizeObserver.observe(container);
                
                // 初始化缩放按钮
                document.querySelectorAll('.scale-button').forEach(button => {
                    button.addEventListener('click', () => {
                        // 移除所有活动按钮
                        document.querySelectorAll('.scale-button').forEach(b => b.classList.remove('active'));
                        
                        // 激活当前按钮
                        button.classList.add('active');
                        
                        // 发送缩放类型到扩展
                        const scaleType = button.getAttribute('data-scale');
                        vscode.postMessage({
                            command: 'setScaleType',
                            scaleType: scaleType
                        });
                    });
                });
                
                // 处理顶部区域折叠/展开功能
                const topContainer = document.getElementById('top-container');
                const collapseButton = document.getElementById('collapse-button');
                
                collapseButton.addEventListener('click', () => {
                    topContainer.classList.toggle('collapsed');
                    
                    // 更新按钮图标
                    if (topContainer.classList.contains('collapsed')) {
                        collapseButton.textContent = '▼';
                        collapseButton.title = '展开面板';
                    } else {
                        collapseButton.textContent = '▲';
                        collapseButton.title = '折叠面板';
                    }
                    
                    // 触发窗口大小变化事件，以便重新渲染
                    const event = new Event('resize');
                    window.dispatchEvent(event);
                });
                
                // HDU选择器相关函数
                function updateHDUSelector(count) {
                    const selector = document.getElementById('hdu-selector');
                    
                    // 移除现有的事件监听器（如果有）
                    const oldSelector = selector.cloneNode(false);
                    selector.parentNode.replaceChild(oldSelector, selector);
                    
                    // 使用新的选择器引用
                    const newSelector = oldSelector;
                    newSelector.innerHTML = '';
                    
                    for (let i = 0; i < count; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i === 0 ? 'Primary HDU' : `Extension HDU ${i}`;
                        newSelector.appendChild(option);
                    }
                    
                    // 添加选择事件
                    newSelector.addEventListener('change', () => {
                        const hduIndex = parseInt(newSelector.value);
                        vscode.postMessage({
                            command: 'switchHDU',
                            hduIndex: hduIndex
                        });
                    });
                }
                
                // 监听来自扩展的消息
                window.addEventListener('message', event => {
                    const message = event.data;
                    
                    switch (message.command) {
                        case 'setFileName':
                            document.getElementById('file-value').textContent = message.fileName;
                            break;
                            
                        case 'setObjectName':
                            document.getElementById('object-value').textContent = message.objectName || '未知';
                            break;
                            
                        case 'setHeaderInfo':
                            // 显示头文件信息
                            if (message.text) {
                                document.getElementById('header-info').textContent = message.text;
                            } else if (message.html) {
                                document.getElementById('header-info').innerHTML = message.html;
                            }
                            break;
                            
                        case 'setStatsInfo':
                            document.getElementById('stats-info').innerHTML = message.html || '无统计信息';
                            break;
                            
                        case 'setPixelValue':
                            document.getElementById('pixel-value').textContent = message.value || '-';
                            document.getElementById('wcs-value-1').textContent = message.wcs1 || '-';
                            document.getElementById('wcs-value-2').textContent = message.wcs2 || '-';
                            break;
                            
                        case 'setWCSValue':
                            document.getElementById('wcs-value-1').textContent = message.wcs1 || '-';
                            document.getElementById('wcs-value-2').textContent = message.wcs2 || '-';
                            break;
                            
                        case 'setImageDataFromFile':
                            log(`收到图像数据文件URI: ${message.fileUri}`);
                            // 保存当前的缩放和平移状态
                            const prevZoomLevel = imageViewer.currentImageData ? imageViewer.zoomLevel : null;
                            const prevPanOffsetX = imageViewer.currentImageData ? imageViewer.panOffsetX : null;
                            const prevPanOffsetY = imageViewer.currentImageData ? imageViewer.panOffsetY : null;
                            const prevWidth = imageViewer.currentImageData ? imageViewer.currentImageData.width : null;
                            const prevHeight = imageViewer.currentImageData ? imageViewer.currentImageData.height : null;
                            
                            imageViewer.loadImageDataFromFile(message.fileUri, prevZoomLevel, prevPanOffsetX, prevPanOffsetY, prevWidth, prevHeight);
                            break;
                            
                        case 'setImageData':
                            if (message.rawData) {
                                // 保存当前的缩放和平移状态
                                const prevZoomLevel = imageViewer.currentImageData ? imageViewer.zoomLevel : null;
                                const prevPanOffsetX = imageViewer.currentImageData ? imageViewer.panOffsetX : null;
                                const prevPanOffsetY = imageViewer.currentImageData ? imageViewer.panOffsetY : null;
                                const prevWidth = imageViewer.currentImageData ? imageViewer.currentImageData.width : null;
                                const prevHeight = imageViewer.currentImageData ? imageViewer.currentImageData.height : null;
                                
                                imageViewer.loadImageData(message.rawData, prevZoomLevel, prevPanOffsetX, prevPanOffsetY, prevWidth, prevHeight);
                            } else {
                                // 显示错误信息
                                document.getElementById('fits-canvas').style.display = 'none';
                                const imagePlaceholder = document.getElementById('image-placeholder');
                                imagePlaceholder.style.display = 'block';
                                imagePlaceholder.textContent = message.message || '无法显示图像数据';
                            }
                            break;
                            
                        case 'setHDUCount':
                            updateHDUSelector(message.count);
                            break;
                            
                        case 'setSelectedHDU':
                            document.getElementById('hdu-selector').value = message.hduIndex;
                            break;
                            
                        case 'showSpectrum':
                            log('收到显示光谱的命令');
                            // 隐藏图像Canvas，显示光谱Canvas
                            document.getElementById('fits-canvas').style.display = 'none';
                            document.getElementById('spectrum-canvas').style.display = 'block';
                            document.getElementById('image-placeholder').style.display = 'none';
                            
                            // 清空WCS信息
                            document.getElementById('wcs-value-1').textContent = '-';
                            document.getElementById('wcs-value-2').textContent = '-';
                            
                            // 隐藏图像缩放按钮，显示光谱列选择器
                            document.getElementById('image-scale-buttons').style.display = 'none';
                            document.getElementById('spectrum-column-selectors').style.display = 'flex';
                            
                            // 如果有可用列信息，填充列选择器
                            if (message.columns && message.columns.length > 0) {
                                spectrumViewer.availableColumns = message.columns;
                                spectrumViewer.updateColumnSelectors(message.columns, message.wavelengthColumn, message.fluxColumn);
                            }
                            
                            // 渲染光谱数据
                            spectrumViewer.renderSpectrum(message.data);
                            break;
                            
                        case 'setControlsVisibility':
                            // 设置图像缩放按钮的可见性
                            document.getElementById('image-scale-buttons').style.display = 
                                message.showImageControls ? 'flex' : 'none';
                            
                            // 设置光谱列选择器的可见性
                            document.getElementById('spectrum-column-selectors').style.display = 
                                message.showSpectrumControls ? 'flex' : 'none';
                            break;
                    }
                });
                
                // 通知扩展webview已准备好
                vscode.postMessage({
                    command: 'webviewReady'
                });
            } catch (error) {
                console.error('初始化失败:', error);
            }
        });
    </script>
</head>
<body>
    <!-- 顶部区域容器 -->
    <div class="top-container" id="top-container">
        <!-- 折叠按钮 -->
        <div class="collapse-button" id="collapse-button">▲</div>
        
        <!-- 第二行：信息显示区 -->
        <div class="info-panel">
            <div class="info-left">
                
                <!-- 像素值信息 -->
                <div class="info-label" style="text-align: left;">Value:</div>
                <div class="info-value" id="pixel-value">-</div>
                
                <!-- WCS坐标 -->
                <div class="info-value" id="wcs-coords-container">
                    <span class="info-label" style="text-align: left;">WCS1:</span>
                    <span class="info-value" id="wcs-value-1">-</span>
                    <span class="info-label" style="text-align: left;">WCS2:</span>
                    <span class="info-value" id="wcs-value-2">-</span>
                </div>
                
                <!-- 图像坐标 -->
                <div class="info-value" id="image-coords-container">
                    <span class="info-label">X:</span>
                    <span class="info-value" id="image-coords-x">-</span>
                    <span class="info-label">Y:</span>
                    <span class="info-value" id="image-coords-y">-</span>
                </div>
                
                <!-- 通道切换选项 -->
                <div class="info-value" id="channel-selector-container" style="display: none;">
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <span class="info-label">通道:</span>
                        <input type="range" id="channel-slider" min="0" value="0" style="flex-grow: 1; margin: 0 10px;">
                        <span class="info-value" id="channel-value">0/0</span>
                        <span class="info-label" style="margin-left: 15px;">轴顺序:</span>
                        <select id="axes-order-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; margin-left: 5px; width: 80px;">
                            <option value="0,1,2">1 2 3</option>
                            <option value="0,2,1">1 3 2</option>
                            <option value="1,0,2">2 1 3</option>
                            <option value="1,2,0">2 3 1</option>
                            <option value="2,0,1">3 1 2</option>
                            <option value="2,1,0">3 2 1</option>
                        </select>
                    </div>
                </div>
            </div>
            
            
            <div class="header-info-container">
                <h3>头文件信息</h3>
                <div class="header-scroll">
                    <pre id="header-info" style="white-space: pre-wrap; margin: 0;">无头文件信息</pre>
                </div>
            </div>
        </div>
        
        <!-- 控制区容器 -->
        <div class="controls-container">
            <!-- 第三行：缩放控制区 -->
            <div class="scale-controls">
                <!-- 图像缩放按钮组 -->
                <div id="image-scale-buttons" class="scale-buttons-group">
                    <div class="scale-button active" data-scale="linear">linear</div>
                    <div class="scale-button" data-scale="log">log</div>
                    <div class="scale-button" data-scale="power">power</div>
                    <div class="scale-button" data-scale="sqrt">sqrt</div>
                    <div class="scale-button" data-scale="squared">squared</div>
                    <div class="scale-button" data-scale="asinh">asinh</div>
                    <div class="scale-button" data-scale="sinh">sinh</div>
                    <div class="scale-button" data-scale="histogram">histogram</div>
                    <div class="scale-button" data-scale="minmax">min max</div>
                    <div class="scale-button" data-scale="zscale">zscale</div>
                </div>
                
                <!-- 光谱列选择器 - 默认隐藏 -->
                <div id="spectrum-column-selectors" class="spectrum-controls" style="display: none;">
                    <div style="display: flex; align-items: center; margin-right: 15px;">
                        <span style="margin-right: 5px; color: var(--vscode-foreground);">波长: </span>
                        <select id="wavelength-column-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; min-width: 120px;">
                            <option value="">未选择</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="margin-right: 5px; color: var(--vscode-foreground);">流量: </span>
                        <select id="flux-column-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; min-width: 120px;">
                            <option value="">未选择</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; margin-left: 15px;">
                        <button id="zoom-box-button" style="background-color: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; padding: 3px 8px; border-radius: 2px; cursor: pointer;">放大</button>
                    </div>
                </div>
                
                <!-- HDU选择器 -->
                <div style="margin-left: auto; display: flex; align-items: center;">
                    <span style="margin-right: 10px; color: var(--vscode-foreground);">HDU: </span>
                    <select id="hdu-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px;">
                        <option value="0">Primary HDU</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 第四行：图像显示区 -->
    <div class="image-container">
        <canvas id="fits-canvas" class="image-display"></canvas>
        <canvas id="spectrum-canvas" class="spectrum-display" style="display: none;"></canvas>
        <div id="image-placeholder" class="image-placeholder">加载中...</div>
        <div id="pixel-info" class="pixel-info"></div>
        <div id="zoom-indicator" class="zoom-indicator" style="display: none;">缩放: 100%</div>
    </div>
    
    <!-- 添加状态栏 -->
    <div class="status-bar">
        <div id="status-info">准备就绪</div>
    </div>
</body>
</html> 