<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FITS 文件查看器</title>
    <link rel="stylesheet" href="theme.css">
    <script type="module">
        // Wait for DOM to load | 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { vscode, log } = await import('./common.js');
                const { default: ImageViewer } = await import('./image-viewer.js');
                const { default: SpectrumViewer } = await import('./spectrum-viewer.js');
                
                // Format table values | 格式化表格中的值
                function formatValue(value, dataType) {
                    console.log('formatValue input:', {
                        value,
                        type: typeof value,
                        isArray: Array.isArray(value),
                        isTypedArray: ArrayBuffer.isView(value),
                        dataType,
                        constructor: value?.constructor?.name
                    });

                    if (value === null || value === undefined) {
                        return '';
                    }

                    // Handle boolean type | 处理布尔类型
                    if (typeof value === 'boolean' || dataType === 'L') {
                        return value.toString();
                    }
                    
                    // Handle array type | 处理数组类型
                    if (Array.isArray(value) || ArrayBuffer.isView(value)) {
                        // Convert TypedArray to normal array | 如果是TypedArray，转换为普通数组
                        const arr = Array.from(value);
                        console.log('Array processing:', {
                            originalValue: value,
                            convertedArray: arr,
                            length: arr.length
                        });
                        // Format each value in array | 对数组中的每个值进行格式化
                        return arr.map(v => {
                            if (typeof v === 'number') {
                                return Number.isInteger(v) ? v.toString() : v.toFixed(6);
                            }
                            return v.toString().trim();
                        }).join(', ');
                    }
                    
                    // Handle string type | 处理字符串类型
                    if (dataType === 'A' || dataType.startsWith('A')) {
                        return value.toString().trim();
                    }
                    
                    // Handle numeric type | 处理数值类型
                    if (typeof value === 'number') {
                        // Keep 6 decimal places for non-integers | 对于非整数，保留6位小数
                        return Number.isInteger(value) ? value.toString() : value.toFixed(6);
                    }
                    
                    return value.toString();
                }

                // Table sorting functionality | 表格排序功能
                let currentSortColumn = null;
                let isAscending = true;

                function sortTable(columnName) {
                    const headers = document.querySelectorAll('#fits-table th');
                    
                    // Remove all sort markers | 移除所有排序标记
                    headers.forEach(header => {
                        header.classList.remove('sorted-asc', 'sorted-desc');
                    });
                    
                    // Reverse sort direction if clicking current sort column | 如果点击的是当前排序列，则反转排序方向
                    if (columnName === currentSortColumn) {
                        isAscending = !isAscending;
                    } else {
                        currentSortColumn = columnName;
                        isAscending = true;
                    }
                    
                    // Add sort marker | 添加排序标记
                    const header = document.querySelector(`th[data-column="${columnName}"]`);
                    header.classList.add(isAscending ? 'sorted-asc' : 'sorted-desc');

                    // Get column data type | 获取列的数据类型
                    const dataType = header.getAttribute('data-type');
                    
                    // Sort all data | 对所有数据进行排序
                    window.tableState.allRows.sort((a, b) => {
                        const aValue = a[columnName];
                        const bValue = b[columnName];
                        
                        // Handle null values | 处理空值
                        if (aValue === null || aValue === undefined) return isAscending ? -1 : 1;
                        if (bValue === null || bValue === undefined) return isAscending ? 1 : -1;
                        
                        // Compare based on data type | 根据数据类型进行比较
                        if (dataType === 'L') {  // Boolean type | 布尔类型
                            return isAscending ? 
                                aValue === bValue ? 0 : aValue ? 1 : -1 :
                                aValue === bValue ? 0 : aValue ? -1 : 1;
                        }
                        
                        // Numeric comparison | 数值类型比较
                        if (typeof aValue === 'number' && typeof bValue === 'number') {
                            return isAscending ? aValue - bValue : bValue - aValue;
                        }
                        
                        // Try numeric comparison for string numbers | 尝试数字比较（字符串形式的数字）
                        const aNum = parseFloat(aValue);
                        const bNum = parseFloat(bValue);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return isAscending ? aNum - bNum : bNum - aNum;
                        }
                        
                        // String comparison | 字符串比较
                        return isAscending ? 
                            String(aValue).localeCompare(String(bValue)) : 
                            String(bValue).localeCompare(String(aValue));
                    });
                    
                    // Re-render current page | 重新渲染当前页
                    renderCurrentPage();
                }

                // Process table data | 处理表格数据
                function processTableData(data) {
                    console.log('Processing table data:', data);
                    const { columns, rows } = data;
                    
                    // Clear header and body | 清空表头和表体
                    const thead = document.querySelector('#fits-table thead tr');
                    const tbody = document.querySelector('#fits-table tbody');
                    thead.innerHTML = '';
                    tbody.innerHTML = '';

                    // Add headers | 添加表头
                    columns.forEach(col => {
                        const th = document.createElement('th');
                        th.textContent = `${col.name}${col.unit ? ` (${col.unit})` : ''}`;
                        th.setAttribute('data-column', col.name);
                        th.setAttribute('data-type', col.dataType || '');  // Save data type | 保存数据类型
                        th.addEventListener('click', () => sortTable(col.name));
                        thead.appendChild(th);
                    });

                    // Initialize pagination state | 初始化分页状态
                    window.tableState = {
                        allRows: rows,
                        columns: columns,  // Save column info | 保存列信息
                        currentPage: 1,
                        rowsPerPage: 1000,
                        totalPages: Math.ceil(rows.length / 1000)
                    };

                    // Show pagination controls if over 100k rows | 如果数据量超过10万行，显示分页控件
                    const paginationContainer = document.getElementById('pagination-container');
                    if (rows.length > 100000) {
                        paginationContainer.style.display = 'flex';
                        updatePaginationControls();
                    } else {
                        paginationContainer.style.display = 'none';
                        window.tableState.rowsPerPage = rows.length;
                    }

                    // Render current page data | 渲染当前页数据
                    renderCurrentPage();
                }

                // Render current page | 渲染当前页数据
                function renderCurrentPage() {
                    const { allRows, currentPage, rowsPerPage } = window.tableState;
                    const tbody = document.querySelector('#fits-table tbody');
                    tbody.innerHTML = '';

                    const startIdx = (currentPage - 1) * rowsPerPage;
                    const endIdx = Math.min(startIdx + rowsPerPage, allRows.length);
                    const currentRows = allRows.slice(startIdx, endIdx);

                    // Get column info | 获取列信息
                    const columns = Array.from(document.querySelectorAll('#fits-table thead th')).map(th => ({
                        name: th.getAttribute('data-column'),
                        dataType: th.getAttribute('data-type')
                    }));

                    currentRows.forEach(row => {
                        const tr = document.createElement('tr');
                        columns.forEach(col => {
                            const td = document.createElement('td');
                            const value = row[col.name];
                            td.textContent = value !== null && value !== undefined ? 
                                formatValue(value, col.dataType) : '';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });

                    // Update pagination info display | 更新分页信息显示
                    document.getElementById('page-info').textContent = 
                        `第 ${currentPage} 页，共 ${window.tableState.totalPages} 页 (总计 ${allRows.length} 行)`;
                }

                // Update pagination controls state | 更新分页控件状态
                function updatePaginationControls() {
                    const { currentPage, totalPages } = window.tableState;
                    document.getElementById('prev-page').disabled = currentPage === 1;
                    document.getElementById('next-page').disabled = currentPage === totalPages;
                    document.getElementById('page-number').value = currentPage;
                    document.getElementById('total-pages').textContent = totalPages;
                }

                // Add pagination event handlers | 添加分页事件处理
                document.getElementById('prev-page')?.addEventListener('click', () => {
                    if (window.tableState.currentPage > 1) {
                        window.tableState.currentPage--;
                        renderCurrentPage();
                        updatePaginationControls();
                    }
                });

                document.getElementById('next-page')?.addEventListener('click', () => {
                    if (window.tableState.currentPage < window.tableState.totalPages) {
                        window.tableState.currentPage++;
                        renderCurrentPage();
                        updatePaginationControls();
                    }
                });

                document.getElementById('page-number')?.addEventListener('change', (e) => {
                    const pageNum = parseInt(e.target.value);
                    if (pageNum >= 1 && pageNum <= window.tableState.totalPages) {
                        window.tableState.currentPage = pageNum;
                        renderCurrentPage();
                        updatePaginationControls();
                    } else {
                        e.target.value = window.tableState.currentPage;
                    }
                });

                // Initialize image viewer and spectrum viewer | 初始化图像查看器和光谱查看器
                const imageViewer = new ImageViewer();
                const spectrumViewer = new SpectrumViewer();
                
                // Add container resize listener | 添加容器大小变化监听
                const container = document.querySelector('.image-container');
                const resizeObserver = new ResizeObserver(entries => {
                    for (const entry of entries) {
                        // Re-render image | 重新渲染图像
                        if (imageViewer.currentImageData) {
                            imageViewer.renderWithTransform();
                        }
                        
                        // Re-render spectrum | 重新渲染光谱
                        const spectrumData = document.getElementById('spectrum-canvas').dataset.spectrumData;
                        if (spectrumData) {
                            spectrumViewer.renderSpectrum(JSON.parse(spectrumData), true);
                        }
                    }
                });
                
                // Start observing container size changes | 开始监听容器大小变化
                resizeObserver.observe(container);
                
                // Initialize scale buttons | 初始化缩放按钮
                document.querySelectorAll('.scale-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const group = button.getAttribute('data-group');
                        
                        // Deactivate all buttons in the same group | 取消激活同组中的所有按钮
                        document.querySelectorAll(`.scale-button[data-group="${group}"]`).forEach(b => {
                            b.classList.remove('active');
                        });
                        
                        // Activate current button | 激活当前按钮
                        button.classList.add('active');
                        
                        // Get current transform type and range type | 获取当前变换类型和范围类型
                        const transformButton = document.querySelector('.transform-group .scale-button.active');
                        const rangeButton = document.querySelector('.range-group .scale-button.active');
                        
                        const scaleType = transformButton ? transformButton.getAttribute('data-scale') : 'linear';
                        const useZScale = rangeButton ? rangeButton.getAttribute('data-scale') === 'zscale' : false;
                        
                        // Send scale transform message to extension | 发送缩放变换消息到扩展
                        vscode.postMessage({
                            command: 'applyScaleTransform',
                            scaleType: scaleType,
                            useZScale: useZScale
                        });
                    });
                });
                
                // Handle top area collapse/expand | 处理顶部区域折叠/展开功能
                const topContainer = document.getElementById('top-container');
                const collapseButton = document.getElementById('collapse-button');
                
                collapseButton.addEventListener('click', () => {
                    topContainer.classList.toggle('collapsed');
                    
                    // Update button icon | 更新按钮图标
                    if (topContainer.classList.contains('collapsed')) {
                        collapseButton.textContent = '▼';
                        collapseButton.title = '展开面板';
                    } else {
                        collapseButton.textContent = '▲';
                        collapseButton.title = '折叠面板';
                    }
                    
                    // Trigger window resize event for re-rendering | 触发窗口大小变化事件，以便重新渲染
                    const event = new Event('resize');
                    window.dispatchEvent(event);
                });
                
                // HDU selector related functions | HDU选择器相关函数
                function updateHDUSelector(count) {
                    const selector = document.getElementById('hdu-selector');
                    
                    // Remove existing event listeners | 移除现有的事件监听器（如果有）
                    const oldSelector = selector.cloneNode(false);
                    selector.parentNode.replaceChild(oldSelector, selector);
                    
                    // Use new selector reference | 使用新的选择器引用
                    const newSelector = oldSelector;
                    newSelector.innerHTML = '';
                    
                    for (let i = 0; i < count; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i === 0 ? 'Primary HDU' : `Extension HDU ${i}`;
                        newSelector.appendChild(option);
                    }
                    
                    // Add selection event | 添加选择事件
                    newSelector.addEventListener('change', () => {
                        const hduIndex = parseInt(newSelector.value);
                        vscode.postMessage({
                            command: 'switchHDU',
                            hduIndex: hduIndex
                        });
                    });
                }
                
                // Add show table button event listener | 添加显示表格按钮事件监听
                document.getElementById('show-table-button').addEventListener('click', () => {
                    vscode.postMessage({
                        command: 'showTable'
                    });
                });
                
                // Return spectrum button click event | 返回光谱按钮点击事件
                document.getElementById('return-spectrum-button')?.addEventListener('click', () => {
                    // Hide table container | 隐藏表格容器
                    document.querySelector('.table-container').style.display = 'none';
                    // Show image container | 显示图像容器（因为光谱canvas在图像容器内）
                    document.querySelector('.image-container').style.display = 'flex';
                    // Show spectrum canvas | 显示光谱canvas
                    document.getElementById('spectrum-canvas').style.display = 'block';
                    // Hide image canvas and placeholder | 隐藏图像canvas和占位符
                    document.getElementById('fits-canvas').style.display = 'none';
                    document.getElementById('image-placeholder').style.display = 'none';
                    // Send return to spectrum message | 发送返回光谱消息
                    vscode.postMessage({
                        command: 'returnToSpectrum'
                    });
                });
                
                // Listen for messages from extension | 监听来自扩展的消息
                window.addEventListener('message', event => {
                    const message = event.data;
                    
                    switch (message.command) {
                        case 'setFileName':
                            document.getElementById('file-value').textContent = message.fileName;
                            break;
                            
                        case 'setObjectName':
                            document.getElementById('object-value').textContent = message.objectName || '未知';
                            break;
                            
                        case 'setHeaderInfo':
                            // Show header info | 显示头文件信息
                            if (message.text) {
                                document.getElementById('header-info').textContent = message.text;
                            } else if (message.html) {
                                document.getElementById('header-info').innerHTML = message.html;
                            }
                            break;
                            
                        case 'setStatsInfo':
                            document.getElementById('stats-info').innerHTML = message.html || '无统计信息';
                            break;
                            
                        case 'setPixelValue':
                            document.getElementById('pixel-value').textContent = message.value || '-';
                            document.getElementById('wcs-value-1').textContent = message.wcs1 || '-';
                            document.getElementById('wcs-value-2').textContent = message.wcs2 || '-';
                            break;
                            
                        case 'setImageDataFromFile':
                            log(`Received image data file URI | 收到图像数据文件URI: ${message.fileUri}`);
                            // Save current zoom and pan state | 保存当前的缩放和平移状态
                            const prevZoomLevel = imageViewer.currentImageData ? imageViewer.zoomLevel : null;
                            const prevPanOffsetX = imageViewer.currentImageData ? imageViewer.panOffsetX : null;
                            const prevPanOffsetY = imageViewer.currentImageData ? imageViewer.panOffsetY : null;
                            const prevWidth = imageViewer.currentImageData ? imageViewer.currentImageData.width : null;
                            const prevHeight = imageViewer.currentImageData ? imageViewer.currentImageData.height : null;
                            
                            imageViewer.loadImageDataFromFile(message.fileUri, prevZoomLevel, prevPanOffsetX, prevPanOffsetY, prevWidth, prevHeight);
                            break;
                            
                        case 'setImageData':
                            if (message.rawData) {
                                // Save current zoom and pan state | 保存当前的缩放和平移状态
                                const prevZoomLevel = imageViewer.currentImageData ? imageViewer.zoomLevel : null;
                                const prevPanOffsetX = imageViewer.currentImageData ? imageViewer.panOffsetX : null;
                                const prevPanOffsetY = imageViewer.currentImageData ? imageViewer.panOffsetY : null;
                                const prevWidth = imageViewer.currentImageData ? imageViewer.currentImageData.width : null;
                                const prevHeight = imageViewer.currentImageData ? imageViewer.currentImageData.height : null;
                                
                                imageViewer.loadImageData(message.rawData, prevZoomLevel, prevPanOffsetX, prevPanOffsetY, prevWidth, prevHeight);
                            } else {
                                // Show error message | 显示错误信息
                                document.getElementById('fits-canvas').style.display = 'none';
                                const imagePlaceholder = document.getElementById('image-placeholder');
                                imagePlaceholder.style.display = 'block';
                                imagePlaceholder.textContent = message.message || 'Cannot display image data';
                            }
                            break;
                            
                        case 'setHDUCount':
                            updateHDUSelector(message.count);
                            break;
                            
                        case 'setSelectedHDU':
                            document.getElementById('hdu-selector').value = message.hduIndex;
                            break;
                            
                        case 'scaleTransformResult':
                            if (message.data) {
                                imageViewer.updateImageData(message.data, message.min, message.max);
                            } else {
                                document.getElementById('fits-canvas').style.display = 'none';
                                const imagePlaceholder = document.getElementById('image-placeholder');
                                imagePlaceholder.style.display = 'block';
                                imagePlaceholder.textContent = 'Cannot apply scale transform';
                            }
                            break;
                            
                        case 'showSpectrum':
                            log('Received show spectrum command | 收到显示光谱的命令');
                            // Hide table container | 隐藏表格容器
                            document.querySelector('.table-container').style.display = 'none';
                            // Show image container | 显示图像容器
                            document.querySelector('.image-container').style.display = 'flex';
                            // Show spectrum canvas, hide others | 显示光谱canvas，隐藏其他
                            document.getElementById('fits-canvas').style.display = 'none';
                            document.getElementById('spectrum-canvas').style.display = 'block';
                            document.getElementById('image-placeholder').style.display = 'none';
                            
                            // Hide return spectrum button | 隐藏返回光谱按钮
                            document.getElementById('return-spectrum-button').style.display = 'none';
                            
                            // Clear WCS info | 清空WCS信息
                            document.getElementById('wcs-value-1').textContent = '-';
                            document.getElementById('wcs-value-2').textContent = '-';
                            
                            // Hide image scale buttons, show spectrum column selectors | 隐藏图像缩放按钮，显示光谱列选择器
                            document.getElementById('image-scale-buttons').style.display = 'none';
                            document.getElementById('spectrum-column-selectors').style.display = 'flex';
                            
                            // Fill column selectors if columns available | 如果有可用列信息，填充列选择器
                            if (message.columns && message.columns.length > 0) {
                                spectrumViewer.availableColumns = message.columns;
                                spectrumViewer.updateColumnSelectors(message.columns, message.wavelengthColumn, message.fluxColumn);
                            }
                            
                            // Render spectrum data | 渲染光谱数据
                            spectrumViewer.renderSpectrum(message.data);
                            break;
                            
                        case 'setControlsVisibility':
                            // Set image scale buttons visibility | 设置图像缩放按钮的可见性
                            document.getElementById('image-scale-buttons').style.display = 
                                message.showImageControls ? 'flex' : 'none';
                            
                            // Set spectrum column selectors visibility | 设置光谱列选择器的可见性
                            document.getElementById('spectrum-column-selectors').style.display = 
                                message.showSpectrumControls ? 'flex' : 'none';
                            break;

                        case 'setTableData':
                            // Process table data | 处理表格数据
                            if (message.data) {
                                processTableData(message.data);
                            }
                            break;

                        case 'showTableView':
                            // Show table view | 显示表格视图
                            document.querySelector('.table-container').style.display = 'flex';
                            document.querySelector('.image-container').style.display = 'none';
                            document.getElementById('fits-canvas').style.display = 'none';
                            document.getElementById('spectrum-canvas').style.display = 'none';
                            document.getElementById('image-placeholder').style.display = 'none';
                            // Show button container | 显示按钮容器
                            document.querySelector('.table-button').parentElement.style.display = 'flex';
                            // Show spectrum return button if needed | 如果需要则显示返回光谱按钮
                            document.getElementById('return-spectrum-button').style.display = 
                                message.isSpectralData ? 'block' : 'none';
                            // Hide spectrum related controls | 隐藏光谱相关控件
                            document.getElementById('spectrum-column-selectors').style.display = 'none';
                            document.getElementById('image-scale-buttons').style.display = 'none';
                            break;
                    }
                });
                
                // Notify extension that webview is ready | 通知扩展webview已准备好
                vscode.postMessage({
                    command: 'webviewReady'
                });
            } catch (error) {
                console.error('Initialization failed | 初始化失败:', error);
            }
        });
    </script>
</head>
<body>
    <!-- Top area container | 顶部区域容器 -->
    <div class="top-container" id="top-container">
        <!-- Collapse button | 折叠按钮 -->
        <div class="collapse-button" id="collapse-button">▲</div>
        
        <!-- Second row: Info display area | 第二行：信息显示区 -->
        <div class="info-panel">
            <div class="info-left">
                
                <!-- Pixel value info | 像素值信息 -->
                <div class="info-label" style="text-align: left;">Value:</div>
                <div class="info-value" id="pixel-value">-</div>
                
                <!-- WCS coordinates | WCS坐标 -->
                <div class="info-value" id="wcs-coords-container">
                    <span class="info-label" style="text-align: left;">WCS1:</span>
                    <span class="info-value" id="wcs-value-1">-</span>
                    <span class="info-label" style="text-align: left;">WCS2:</span>
                    <span class="info-value" id="wcs-value-2">-</span>
                </div>
                
                <!-- Image coordinates | 图像坐标 -->
                <div class="info-value" id="image-coords-container">
                    <span class="info-label">X:</span>
                    <span class="info-value" id="image-coords-x">-</span>
                    <span class="info-label">Y:</span>
                    <span class="info-value" id="image-coords-y">-</span>
                </div>
                
                <!-- Channel switch options | 通道切换选项 -->
                <div class="info-value" id="channel-selector-container" style="display: none;">
                    <div style="display: flex; align-items: center; margin-top: 5px;">
                        <span class="info-label">Axes:</span>
                        <input type="range" id="channel-slider" min="0" value="0" style="flex-grow: 1; margin: 0 10px;">
                        <span class="info-value" id="channel-value">0/0</span>
                        <span class="info-label" style="margin-left: 15px;">Axes Order:</span>
                        <select id="axes-order-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; margin-left: 5px; width: 80px;">
                            <option value="0,1,2">1 2 3</option>
                            <option value="0,2,1">1 3 2</option>
                            <option value="1,0,2">2 1 3</option>
                            <option value="1,2,0">2 3 1</option>
                            <option value="2,0,1">3 1 2</option>
                            <option value="2,1,0">3 2 1</option>
                        </select>
                    </div>
                </div>
            </div>
            
            
            <div class="header-info-container">
                <h3>Fits Header</h3>
                <div class="header-scroll">
                    <pre id="header-info" style="white-space: pre-wrap; margin: 0;">No header info</pre>
                </div>
            </div>
        </div>
        
        <!-- Controls container | 控制区容器 -->
        <div class="controls-container">
            <!-- Third row: Scale controls | 第三行：缩放控制区 -->
            <div class="scale-controls">
                <!-- Table operation buttons | 表格操作按钮 -->
                <div style="display: flex; align-items: center; margin-right: 15px;">
                    <button id="return-spectrum-button" class="table-button" style="margin-left: 10px; display: none;">Show Spectrum</button>
                </div>

                <!-- Image scale buttons group | 图像缩放按钮组 -->
                <div id="image-scale-buttons" class="scale-buttons-group">
                    <!-- Transform group | 变换组 -->
                    <div class="button-group transform-group">
                        <div class="scale-button active" data-scale="linear" data-group="transform">linear</div>
                        <div class="scale-button" data-scale="log" data-group="transform">log</div>
                        <div class="scale-button" data-scale="power" data-group="transform">power</div>
                        <div class="scale-button" data-scale="sqrt" data-group="transform">sqrt</div>
                        <div class="scale-button" data-scale="squared" data-group="transform">squared</div>
                        <div class="scale-button" data-scale="asinh" data-group="transform">asinh</div>
                        <div class="scale-button" data-scale="sinh" data-group="transform">sinh</div>
                        <div class="scale-button" data-scale="histogram" data-group="transform">histogram</div>
                    </div>
                    
                    <!-- Range group | 范围组 -->
                    <div class="button-group range-group">
                        <div class="scale-button active" data-scale="minmax" data-group="range">min max</div>
                        <div class="scale-button" data-scale="zscale" data-group="range">zscale</div>
                    </div>

                    <!-- Bias and contrast controls | 偏差和对比度控制 -->
                    <div class="scale-controls-sliders">
                        <div class="slider-container">
                            <label for="bias-slider">Bias:</label>
                            <input type="range" id="bias-slider" min="0" max="1" step="0.01" value="0.5">
                            <span id="bias-value">0.5</span>
                        </div>
                        <div class="slider-container">
                            <label for="contrast-slider">Contrast:</label>
                            <input type="range" id="contrast-slider" min="0" max="10" step="0.1" value="1">
                            <span id="contrast-value">1.0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Spectrum column selectors - hidden by default | 光谱列选择器 - 默认隐藏 -->
                <div id="spectrum-column-selectors" class="spectrum-controls" style="display: none;">
                    <div style="display: flex; align-items: center; margin-right: 15px;">
                        <span style="margin-right: 5px; color: var(--vscode-foreground);">Wavelength: </span>
                        <select id="wavelength-column-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; min-width: 120px;">
                            <option value="">none</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span style="margin-right: 5px; color: var(--vscode-foreground);">Flux: </span>
                        <select id="flux-column-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px; min-width: 120px;">
                            <option value="">none</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; margin-left: 15px;">
                        <button id="zoom-box-button" style="background-color: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; padding: 3px 8px; border-radius: 2px; cursor: pointer;">Zoom in</button>
                        <button id="show-table-button" style="background-color: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; padding: 3px 8px; border-radius: 2px; cursor: pointer; margin-left: 8px;">Show Table</button>
                    </div>
                </div>
                
                <!-- HDU selector | HDU选择器 -->
                <div style="margin-left: auto; display: flex; align-items: center;">
                    <span style="margin-right: 10px; color: var(--vscode-foreground);">HDU: </span>
                    <select id="hdu-selector" style="background-color: var(--vscode-dropdown-background); color: var(--vscode-dropdown-foreground); border: 1px solid var(--vscode-dropdown-border); padding: 3px; border-radius: 2px;">
                        <option value="0">Primary HDU</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fourth row: Image/Table display area | 第四行：图像/表格显示区 -->
    <div class="image-container">
        <canvas id="fits-canvas" class="image-display"></canvas>
        <canvas id="spectrum-canvas" class="spectrum-display" style="display: none;"></canvas>
        <div id="image-placeholder" class="image-placeholder">Loading...</div>
        <div id="pixel-info" class="pixel-info"></div>
        <div id="zoom-indicator" class="zoom-indicator" style="display: none;">Zoom: 100%</div>
    </div>
    
    <!-- Add status bar | 添加状态栏 -->
    <div class="status-bar">
    </div>

    <!-- Fourth row: Image/Table display area | 第四行：图像/表格显示区 -->
    <div class="table-container" style="display: none;">
        <div class="table-wrapper">
            <table id="fits-table">
                <thead>
                    <tr></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <!-- Add pagination controls | 添加分页控件 -->
        <div id="pagination-container" style="display: none; justify-content: center; align-items: center; padding: 10px; gap: 10px;">
            <button id="prev-page" class="pagination-button">&lt; Previous</button>
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" id="page-number" style="width: 60px; text-align: center;" min="1">
                <span>/ <span id="total-pages">1</span></span>
            </div>
            <button id="next-page" class="pagination-button">Next &gt;</button>
            <span id="page-info" style="margin-left: 10px;"></span>
        </div>
    </div>

    <style>
        /* Add pagination styles | 添加分页相关样式 */
        .pagination-button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 4px 8px;
            border-radius: 2px;
            cursor: pointer;
        }

        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #page-number {
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            padding: 2px 4px;
            border-radius: 2px;
        }

        #pagination-container {
            border-top: 1px solid var(--vscode-panel-border);
            margin-top: 10px;
        }
    </style>
</body>
</html> 